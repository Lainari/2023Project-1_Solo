# Chp 4. 함수 : 함수로 데이터를 쉽게 가공하기

# 1. 함수란?
- 오라클 데이터베이스 시스템에서 제공하는 함수
- 미리 정의된 기능을 통해 데이터를 좀 더 편리하게 조작할 수 있도록 도와준다
- 사용자가 입력 값 X를 넣으면 정해놓은 출력 값 Y가 나오는 개념
  - 자판기를 생각하면 된다
- 문자, 숫자, 날짜 값 등을 조작할 수 있으며 각 데이터 타입(자료형) 끼리 변환할 수도 있다
- 복수의 행을 조합하여 그룹당 하나의 결과로도 출력할 수도 있다

## 함수를 사용하는 목적
 1. 데이터 값을 계산하거나 조작(단일 행 함수)
 2. 행의 그룹에 대해 계산하거나 요약(그룹 함수)
 3. 열의 데이터 타입을 변환
   - 즉, 날짜와 숫자 등 데이터 타입을 상호 변환


# 2. 단일행 함수 : 데이터 값을 하나씩 계산하고 조작하기
- 테이블의 열은 한 가지 데이터 타입으로 지정되어 있음
  - 지정된 데이터 타입과 일치하는 데이터 값만 저장할 수 있다

## 데이터 타입의 종류
```Markdown
1. CHAR(n)      : n 크기만큼 고정 길이의 문자 타입을 저장한다
                  최대 2,000 바이트(Byte)까지 저장할 수 있다
2. VARCHAR2(n)  : n 크기만큼 가변 길이의 문자 타입을 저장한다
                  최대 4,000 바이트(Byte)까지 저장할 수 있다
3. NUMBER(p, s) : 숫자 타입을 저장한다
                  (p : 정수 자릿수, s : 소수 자릿수)
4. DATE         : 날짜 타입을 저장한다.
                  9999년 12월 31일까지 저장할 수 있다
```

## 자료형 타입별 특징
```Markdown
1. 문자 타입 함수 : 문자를 입력받아 문자와 숫자를 반환
2. 숫자 타입 함수 : 숫자를 입력받아 숫자를 반환
3. 날짜 타입 함수 : 날짜에 대해 연산
                   숫자를 반환하는 MONTHS_BETWEEN 함수를 제외한
                   모든 날짜 타입 함수는 날짜 값을 반환
4. 변환 타입 함수 : 임의의 데이터 타입의 값을 다른 데이터 타입으로 변환
5. 일반 함수      : 그 외 NVL, DECODE, CASE WHEN, 순위 함수 등
```

## 단일 행 함수의 특징
1. 각 행에 대해 수행
2. 데이터 타입에 맞는 함수를 사용해야 함
3. 행 별로 하나의 결과를 반환
4. SELECT, WHERE, ORDER BY 절 등에서 사용할 수 있음
5. 함수 속의 함수처럼 중첩해서 사용할 수 있음
6. 중첩해서 사용할 경우 가장 안쪽(하위) 단계에서 바깥쪽(상위) 단계 순으로 진행함

## ⭐문자 타입 함수
- 주로 데이터 조작에 쓰이며 문자나 문자열 데이터는 작은따옴표(')로 묶어서 문자 타입으로 표현

### 1) LOWER, UPPER, INITCAP : 데이터 값을 대소문자로 변환하기
```
1. LOWER('문자열' or 열 이름)
2. UPPER('문자열' or 열 이름)
3. INITCAP('문자열' or 열 이름)

* 열 이름 외에 'ABCD' 형태로 직접 데이터 값을 넣어도 됨
```
- SQL은 데이터 값의 대소문자를 구문하기 때문에 데이터 출력 값을 표준화할 때 유용

1. LOWER 함수   : 데이터 값을 소문자로 변환
2. UPPER 함수   : 데이터 값을 대문자로 변환
3. INITCAP 함수 : 데이터 값의 첫 번째 문자만 대문자로 변환할 떄 사용

 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 last_name을 소문자와 대문자로 각각 출력하고, email의 첫 번째 문자는 대문자로 출력하시오
 ```
 ```SQL
  SELECT last_name,
         [        ], 소문자 적용
         [        ], 대문자 적용
         email,
         [        ] email 첫 번째 대문자 적용
  FROM employees;
 ```

### 2) SUBSTR : 지정한 길이만큼 문자열 추출하기
```
SUBSTR('문자열' or 열 이름, 시작 위치, 길이)

* 시작 위치는 추출 시작 자리 위치를 말하며, 길이는 추출할 길이를 뜻한다
```
- SUBSTR 함수는 데이터에서 지정된 길이만큼 문자열을 추출할 때 사용
  - 데이터 값이 이미 가공되어 데이터베이스에 저장되어 있는 경우에서
    일부 문자열을 잘라내 또 다시 가공해야 할 때 유용

 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 job_id 데이터 값의 첫째 자리부터 시작해서 두 개의 문자를 출력하시오
 ```
 ```SQL
  SELECT
    job_id,
    [        ] 적용 결과
  FROM employees;
 ```

### 3) REPLACE : 특정 문자를 찾아 바꾸기
```
REPLACE('문자열' or 열 이름, '바꾸려는 문자열', '바뀔 문자열')
```
- REPLACE는 특정 문자열을 찾아 바꾸는 함수
  - 사용자가 바꾸고자 하는 문자나 문자열을 지정하면 지정한 형태로 문자(열)이 바뀜
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 job_id 문자열 값이 ACCOUNT면 ACCNT로 출력하세요
 ```
 ```SQL
  SELECT
    job_id,
    [          ] 적용결과
  FROM employees;
 ```

### 4) LPAD, RPAD : 특정 문자로 자릿수 채우기
```
LPAD or RPAD('문자열' or 열 이름, 만들어질 자릿수, '채워질 문자')
```
- LPAD는 왼쪽부터 특정 문자로 자릿수를 채우고 RPAD는 오른쪽에서 시작한다

 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 first_name에 대해 12자리의 문자열 자리를 만들어라
  여기서 first_name의 데이터 값이 12자리보다 작으면 왼쪽에서부터 * 를 채워서  출력하라
 ```
 ```SQL
   SELECT
    first_name,
    [            ] 적용결과
   FROM employees;
 ```
 - 오른쪽에서도 넣은 결과도 따로 확인해보세요

### 5) LTRIM, RTRIM : 특정 문자 삭제하기
```
LTRIM('문자열' or 열 이름, '삭제할 문자')

* 삭제할 문자가 없다면 공백을 제거한다
```
- LTRIM은 왼쪽부터 지정한 문자를 지우는 함수며 RTRIM은 오른쪽부터 제거한다
- 지정한 문자 외의 값을 만나면 진행을 중단한다
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 job_id의 데이터 값에 대해 왼쪽방향부터 'F' 문자를 만나면 삭제하라
  또한 오른쪽 방향부터 'T' 문자를 만나면 삭제하라
 ```
 ```SQL
  SELECT job_id,
   [             ],   왼쪽 제거 구현
   [             ]    오른쪽 제거 구현
  FROM employees;
 ```

### 6) TRIM : 공백 제거하기
```
TRIM('문자열' or 열 이름)
```
- TRIM 함수는 공백(space)을 제거하는 데 사용함
- 단, 문자열 중간에 있는 공백은 제거할 수 없다
 ### 다음의 코드의 결과를 서술하시오
 ```SQL
  SELECT 'start' || TRIM('   - space -    ') ||'end'
  FROM dual;
 ```

### 7) DUAL 테이블
- 더미(Dummy) 라는 하나의 열과 'X' 라는 하나의 데이터 값을 갖고 있는 테이블
- 임의의 값을 알고자 하거나 특정 테이블을 참고하지 않아도 될 때 유용하게 사용

* * *
## ⭐숫자 타입 함수

### 1) ROUND : 숫자 반올림하기
```
ROUND(숫자 or 열 이름, 반올림할 자리 값)

* 반올림할 자리 값에는 음수(-)에서 양수(+)까지 지정가능하고 0은 소수점 첫째 자리다
```
- ROUND는 지정한 자리에서 반올림하는 함수이다
  - 반올림할 자리 값을 생략한 경우 0으로 되며 첫째 자리에서 반올림한다
  - 음수면 정수 자리에서 반올림하게 된다
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 salary를 30일로 나눈 후 나눈 값의 소수점 첫째 자리,
  소수점 둘째 자리, 정수 첫째 자리에서 반올림한 값을 출력하라
 ```
 ```SQL
   SELECT salary,
          salary / 30 AS 일급,
          [           ],  소수점 첫째자리
          [           ],  소수점 둘째자리
          [           ]   정수 첫째자리
   FROM employees;
 ```

### 2) TRUNC : 숫자 절삭하기
```
TRUNC(숫자 or 열 이름, 절삭할 자리 값)

* 절삭할 자리 값에는 음수(-)에서 양수(+)까지 지정가능하고 0은 소수점 첫째 자리다
```
- TRUNC는 지정한 숫자 자리에서 숫자를 절삭(수샂를 버림) 하는 함수다
- 기본 문법은 ROUND 함수와 동일하다
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```SQL
   SELECT salary,
          salary / 30 AS 일급,
          [             ], 소수점 첫째 자리
          [             ], 소수점 둘째 자리
          [             ], 정수 첫째 자리
 ```

* * *
## ⭐날짜 타입 함수
- MONTHS_BETWEEN은 날짜를 연산하여 숫자로 출력한다
- 해당 함수를 제외한다면 모든 날짜 함수는 결과를 날짜 타입으로 출력한다

### 날짜의 연산 규칙
1. 날짜에 숫자를 더하거나 빼면 날짜 결과를 출력
2. 날짜에서 날짜를 빼면 두 날짜 사이의 일수를 출력
3. 날짜에 시간을 더하거나 뺴려면 시간을 24로 나누어서 더하거나 빼기
```
 1. Date + Number : 날짜에 일수를 더한다 -> return Date
 2. Date - Number : 날짜에서 일수를 뺀다 -> return Date
 3. Date - Date : 날짜에서 날짜를 뺀다 -> return 일수
 4. Date + Number / 24 : 날짜에서 시간을 24로 나누어서 날짜에 더한다 -> return Date
```
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  오늘 날짜를 YY MM DD HH24:MI 유형으로 표현하고
  오늘 날에서 1을 더한 값, 1을 뺀 값,
  2017년 12월 2일에서 2017년 12월 1일을 뺀 값,
  오늘 날짜에서 13시간을 더한 값을 출력하라
 ```
 ```SQL
   SELECT
     TO_CHAR( [      ], [         ] ) 오늘날짜,
     [         ] 다음 날,
     [         ] 어제,
     [                   ] 2017년 12월 2일 - 2017년 12월 1일,
     [         ] 오늘날에 13시간 더하기
   FROM DUAL;
 ```
- 한글판 오라클 익스프레스는 기본으로 년(YY) / 월(MM) / 일(DD) 형태로 출력
- 일시적으로 날짜 언어, 포맷 바꾸는 방법
```SQL
alter session set nls_date_language = 'American';
alter session set nls_date_format = 'yyyy-mm-dd';
```
```
날짜 표기 종류
1. YYYY-MM-DD : 연 4자리, 월 2자리, 일 2자리
2. YYYY 또는 RRRR : 연도 4자리
3. YY 또는 RR : 연도 2자리
4. MM : 월 2자리
5. Mon : 월(월이름 약칭)
6. Month : 월(월이름 전체)
```

### 1) MONTHS_BETWEEN : 두 날짜 사이의 개월 수 계산하기
```
MONTHS_BETWEEN(날짜, 날짜)
```
- MONTHS_BETWEEN 함수는 날짜와 날짜 사이의 개월 수를 계산한다
- 결과는 양수나 음수가 될 수 있다
- 날짜 대신 날짜 데이터 타입의 열 이름을 기술해도 된다
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 department_id 가 100인 직원에 대해
  오늘 날짜, hire_date, 오늘날짜와 hire_date 사이의 개월 수를 출력하라
 ```
 ```SQL
   SELECT
    [        ] 오늘 날짜,
    hire_date,
    [                  ] 오늘날짜와 hire_date 사이 개월 수
   FROM employees
   [            ] 조건;
 ```

### 2) ADD_MONTHS : 월에 날짜 더하기
```
ADD_MONTHS(날짜, 숫자)
```
- ADD_MONTHS는 날짜에 월을 빼거나 더하는 함수
- 결과는 날짜 타입으로 출력
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 employee_id가 100과 106 사이인 직원의 hire_date에
  3개월을 더한 값, hire_date에 3개월을 뺀 값을 출력하라
 ```
 ```SQL
   SELECT
    hire_date,
    [           ] 3개월 더한 값,
    [           ] 3개월 뺀 값
   FROM employees
   [              ] 조건;
 ```

### 3) NEXT_DAY : 돌아오는 요일의 날짜 계산하기
```
NEXT_DAY(날짜, '요일' or 숫자)
```
- NEXT_DAY는 지정된 요일의 돌아오는 날짜가 언제인지 계산하는 함수
- 문자로 '일요일', '월요일' 과 같이 요일을 기술하면 됨
- 숫자로 일요일은 1, 월요일은 2와 같이 기술 할 수도 있음
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 employee_id가 100과 106 사이인 직원의 hire_date에서
  가장 가까운 금요일의 날짜가 언제인지 문자와 숫자로 지정해서 출력하라
 ```
 ```SQL
   SELECT
    hire_date,
    [                ] 문자 적용,
    [                ] 숫자 적용
   FROM employees
   [                 ] 조건;
 ```

### 4) LAST_DAY : 돌아오는 월의 마지막 날짜 계산하기
```
LAST_DAY(날짜)
```
- LAST_DAY는 월의 마지막 날짜를 계산해서 출력하는 함수
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 employee_id가 100과 106 사이인 직원의 hire_date 기준으로
  해당 월의 마지막 날짜를 출력하라
 ```
 ```SQL
   SELECT
    hire_date,
    [                  ] 적용 결과
   FROM employees
   [              ] 조건;
 ```

### 5) ROUND, TRUNC : 날짜 반올림, 절삭
```
ROUND or TRUNC(날짜, 지정 값)

* 지정 값에는 계산하려는 날짜 인자 값을 넣되, MONTH, YEAR 등을 사용한다
```
- ROUND는 지정된 값을 기준으로 반올림하는 함수
- TRUNC는 지정된 값을 기준으로 월 또는 연도로 절삭하는 함수
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 employee_id가 100과 106 사이인 직원의 hire_date에 대해
  월 기준 반올림, 연 기준 반올림, 월 기준 절삭, 연 기준 절삭을 적용하여 출력하라
 ```
 ```SQL
   SELECT
    hire_date,
    [                  ] 월 기준 반올림,
    [                  ] 연 기준 반올림,
    [                  ] 월 기준 절삭,
    [                  ] 연 기준 절삭
   FROM employees
   [              ] 조건;
 ```

* * *
## ⭐변환 함수
- SQL문을 실행하기 위해 데이터 값을 변환해야할 때 사용하는 함수

### 자동 데이터 타입 변환
```
숫자(NUMBER) <-> 문자(CHAR 또는 VARCHAR2) <-> 날짜(DATE)
```
 ### 다음의 코드 실행 결과는?
 ```SQL
  SELECT 1 + '2'
  FROM DUAL;
 ```

### ⭐수동 데이터 타입 변환
- 사용자가 데이터 타입의 값을 다른 데이터 타입의 값으로 변환하게하는 함수
```
숫자(NUMBER) ▶ TO_CHAR ▶ 문자(CHAR 또는 VARCHAR2) ▶ TO_DATE ▶ 날짜(DATE)
날짜(DATE) ▶ TO_CHAR ▶ 문자(CHAR 또는 VARCHAR2) ▶ TO_NUMBER ▶ 숫자(NUMBER)
```

### 1) TO_CHAR
```
TO_CHAR(날짜 데이터 타입, '지정 형식')
```
- 날짜, 숫자, 문자 값을 지정한 형식의 VARCHAR2 타입 문자열로 변환하는 함수
```
날짜 지정형식은 아래와 같다
- CC : 세기
- YYYY or YYY or YY or Y : 연도
- Y,YYY : 콤마가 있는 연도(2,023)
- YEAR : 문자로 표현된 연도
- BC or AD : BC/AD 지시자
- Q : 분기
- MM : 두자리 값의 월
- MONTH : 아홉 자리를 위해 공백을 추가한 월 이름
- MON : 세 자리의 약어로 된 월 이름(영문 설정 경우)
- RM : 로마 숫자 월
- WW or W : 연, 월의 주
- DDD or DD or D : 연, 월, 주의 일
- DAY : 아홉 자리를 위해 공백을 추가한 요일 이름
- DY : 세 자리의 약어로 된 요일 이름(영문 설정 경우)
- J : BC 4713년 12월 31일 이후의 요일 수
```
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  dual 테이블에서 오늘 날짜를 기준으로
  2자리 연도, 4자리 연도, 두자리 값의 월, 세 자리 약어 월 이름, 4자리 연도2자리월2자리일을 적용하여 출력하라
 ```
 ```SQL
   SELECT
    [                  ] 2자리 연도,
    [                  ] 4자리 연도,
    [                  ] 두자리 값의 월,
    [                  ] 세 자리 약어 월 이름,
    [                  ] 4자리연도2자리월2자리일
   FROM dual;
 ```
```
시간 지정형식은 아래와 같다
- AM or PM : 오전 또는 오후 표시
- HH / HH12 or HH24 : 시간 표현(1~12시 또는 0~23시)
- MI : 분(0~59)
- SS : 초(0~59)
```
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  dual 테이블에서 오늘 날짜를 기준으로
  HH, MI, SS, PM 시간 형식과 YYYY/MM/DD HH,MI,SS PM을 적용하여 각각 출력하라
 ```
 ```SQL
   SELECT
    [                  ] HH MI SS PM 적용
    [                  ] YYYY/MM/DD HH MI SS PM 적용
   FROM dual;
 ```
- 시간 지정 형식이 적용되어 출력될 때, 기타 형식을 통해 꾸며줄 수 있다
```
기타 형식
- / . - : 사용 문자를 출력 결과에 표현
- "문자" 큰 따옴표 안의 문자를 출력 결과에 표현
```
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  위 예제 문제의 형식에서 HH MI SS PM 에서는 '-' 문자를 추가하여 적용하고
  "날짜:" YYYY/MM/DD "시각:" HH:MI:SS PM 형식으로 출력하라
 ```
 ```SQL
   SELECT
    [                  ] HH MI SS PM 적용
    [                  ] YYYY/MM/DD HH MI SS PM 적용
   FROM dual;
 ```
- TO_CHAR는 날짜 뿐만 아니라 숫자 값을 지정한 형식의 문자열로 변환할 수 있다
```
TO_CHAR(숫자 데이터 타입, '지정 형식')
```
```
숫자 지정 형식은 다음과 같다
- 9 : 9로 출력 자릿수 지정(   24000)
- 0 : 자릿수만큼 0을 출력(00024000)
- $ : 달러 기호($24,000)
- L : 지역 화폐 기호(원)(₩24,000)
- . : 명시한 위치에 소수점(24000.00)
- , : 명시한 위치에 쉼표(24,000)
```

### 2) TO_NUMBER
```
TO_NUMBER(number)
```
- TO_NUMBER는 숫자 타입의 문자열을 숫자 데이터 타입으로 변환하는 함수다
- 출력 결과는 변하지 않고 데이터 타입만 바뀜
 ### 다음의 코드에서 결과 데이터 타입은?
 ```SQL
  SELECT TO_NUMBER('123')
  FROM dual;
 ```

### 3) TO_DATE
```
TO_DATE(문자열, '지정형식')
```
- TO_DATE는 날짜를 나타내는 문자열을 명시된 날짜로 변환하는 함수다
- 주로 출력 값을 명시된 형태로 나타나게 하거나 날짜를 계산할 때 사용
 ### 다음의 결과가 나오도록 코드를 작성하시오
 ```SQL
 1 | 23/05/02

 SELECT [           ]
 FROM dual;
 ```

* * *
## ⭐일반 함수

### 1) NVL : NULL값 처리하기
```
NVL(열 이름, 치환 값)

* 열 이름에는 null이 포함된 열이나 표현 값을 넣고
  치환 값에서는 null에서 변환하고자 하는 값을 넣는다
```
- null 값은 다음과 같은 특징이 있다
  - 할당되지 않았거나 알려져 있지 않아 적용이 불가능한 값
  - 0이나 공백(space)과는 다르다
  - null 값을 포함하는 산술 연산의 결과는 null 이다
 ### 다음의 문제에서 빈칸에 들어갈 명령어를 기술하시오
 ```
  employees 테이블에서 salary에 commission_pct를 곱하되
  commission_pct가 null 일때는 1로 치환하여 commission_pct를 곱한 결과를 출력하라
  (단, commission_pct를 기준으로 오름차순 정렬을 진행한다)
 ```
 ```SQL
   SELECT
    [                  ] 적용 결과
   FROM employees
   [               ] 오름차순;
 ```
- 비슷한 유형에는 NVL2 함수가 있다
```
NVL2(열이름1, 열이름2, 열이름3)

* 열 이름 1이 null 이 아니면 열 이름2, null 이면 열 이름3 출력
```

### 2) DECODE : 조건 논리 처리하기
```
DECODE(열 이름, 조건 값, 치환 값, 기본값)

* 치환값엔 조건 값에 해당할 경우 출력 값을 설정하고
  기본 값에 조건 값에 해당하지 않을 경우 출력값을 설정한다
```